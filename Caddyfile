# Caddyfile for githook.sh
# Root path: browsers get HTML, curl/wget get the script
# All other paths: serve files normally

{
	admin off
	auto_https off
}

:80 {
	root * /srv/site

	# Health check
	handle /health {
		respond "OK" 200
	}

	# /source always returns the script
	handle /source {
		rewrite * /githook.sh
		header Content-Type "text/plain; charset=utf-8"
		file_server
	}

	# Root path only: browsers vs curl/wget
	handle / {
		# ?source query param forces script download
		@source query source=*
		handle @source {
			rewrite * /githook.sh
			header Content-Type "text/plain; charset=utf-8"
			file_server
		}
		# Detect browsers - they all include Mozilla in User-Agent
		@browser header_regexp User-Agent (?i)Mozilla

		# Browsers get HTML
		handle @browser {
			rewrite * /index.html
			file_server
		}

		# Everything else (curl, wget, etc.) gets the script
		handle {
			rewrite * /githook.sh
			header Content-Type "text/plain; charset=utf-8"
			file_server
		}
	}

	# All other paths: serve files normally
	handle {
		file_server
	}

	log {
		output stdout
		format json
	}
}
