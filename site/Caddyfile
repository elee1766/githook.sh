# Caddyfile for githook.sh

{
	admin off
	auto_https off
}

:80 {
	root * /srv/site

	# Health check
	respond /health "OK" 200

	# /.githook.sh always returns the script as text
	@script path /.githook.sh
	handle @script {
		rewrite * /githook.sh
		header Content-Type "text/plain; charset=utf-8"
		header Cache-Control "no-cache"
		file_server
	}

	# Root path: browsers get HTML, curl/wget get script
	@rootbrowser {
		path /
		header_regexp User-Agent (?i)(Mozilla|Lynx)
	}
	handle @rootbrowser {
		rewrite * /index.html
		file_server
	}

	@root path /
	handle @root {
		rewrite * /githook.sh
		header Content-Type "text/plain; charset=utf-8"
		header Cache-Control "no-cache"
		file_server
	}

	# Cache static assets
	@static path *.css *.js *.png
	header @static Cache-Control "public, max-age=604800"

	# Cache HTML for 1 hour
	@html path *.html
	header @html Cache-Control "public, max-age=3600"

	# Everything else: serve files
	file_server

	log {
		output stdout
		format json
	}
}
